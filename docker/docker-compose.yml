# IronCurtain — Full Platform Deployment
# 
# Runs the entire AI vs AI RTS competitive platform:
#   - Arena Server (matchmaking, game management, API, WebSocket proxy)
#   - Headless OpenRA game servers (one per match)
#   - PostgreSQL (agents, matches, ratings)
#   - Redis (queue, sessions, pub/sub)
#   - Web Portal (Next.js frontend)
#   - Broadcaster (AI commentary + TTS)
#
# Usage:
#   docker compose up -d
#   docker compose scale openra-server=10  # More concurrent matches
#
# Environment:
#   Copy .env.example to .env and configure API keys.

version: "3.8"

services:
  # ─── Core Services ────────────────────────────────
  
  arena-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.arena
    ports:
      - "8080:8080"    # REST API + WebSocket
    environment:
      - DATABASE_URL=postgres://arena:arena@postgres:5432/arena
      - REDIS_URL=redis://redis:6379
      - NODE_ENV=production
      - PORT=8080
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    
  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=arena
      - POSTGRES_PASSWORD=arena
      - POSTGRES_DB=arena
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arena"]
      interval: 10s
      timeout: 5s
      retries: 3
    
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ─── Headless OpenRA Game Servers ─────────────────
  
  openra-server:
    build:
      context: ..
      dockerfile: docker/openra-headless/Dockerfile
    deploy:
      replicas: 5       # Start with 5, scale up as needed
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M
    environment:
      - MAP=Ore Lord
      - GAME_SPEED=normal
      - STARTING_CASH=10000
      - TECH_LEVEL=unrestricted
      - FOG_OF_WAR=true
      - SHROUD=true
    volumes:
      - replays:/opt/openra/replays
    depends_on:
      - arena-server
    restart: unless-stopped

  # ─── Web Portal ──────────────────────────────────
  
  portal:
    build:
      context: ..
      dockerfile: docker/Dockerfile.portal
    ports:
      - "3000:3000"    # Web UI
    environment:
      - ARENA_API_URL=http://arena-server:8080
      - ARENA_WS_URL=ws://arena-server:8080
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NEXT_PUBLIC_WS_URL=ws://localhost:8080
    depends_on:
      - arena-server
    restart: unless-stopped

  # ─── Broadcaster (AI Commentary) ─────────────────
  
  broadcaster:
    build:
      context: ..
      dockerfile: docker/Dockerfile.arena
    command: ["node", "dist/broadcaster/index.js"]
    environment:
      - ARENA_WS_URL=ws://arena-server:8080
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - COMMENTARY_STYLE=esports
    depends_on:
      - arena-server
    restart: unless-stopped

  # ─── Discord Bot ─────────────────────────────────
  
  discord-bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile.arena
    command: ["node", "dist/arena/discord-bot.js"]
    environment:
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - ARENA_API_URL=http://arena-server:8080
      - ARENA_WS_URL=ws://arena-server:8080
    depends_on:
      - arena-server
    restart: unless-stopped

volumes:
  pgdata:
  replays:
